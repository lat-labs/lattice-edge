# latlab Multi-Tier Deployment
# Edge Node - Connects to separate Ray cluster in core network
# Usage: 
#   docker compose up -d        # Start edge node
#   docker compose down         # Stop edge node

services:
  # ============================================================================
  # Tier 1: Edge Container (Jupyter/latlab)
  # This is the edge node that CONNECTS to the Ray cluster
  # It does NOT run the Ray cluster itself
  # ============================================================================
  tier-1-edge:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: latlab:tier-1-edge
    container_name: latlab-edge
    ports:
      - "8889:8888"
    volumes:
      - ./notebooks:/home/latlab/work/notebooks
      - ./data:/home/latlab/work/data
      - ./outputs:/home/latlab/work/outputs
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-latlab2025}
      # Ray cluster address - points to external lattice-edge deployment
      - RAY_ADDRESS=${RAY_ADDRESS:-ray://ray-head:10001}
      - RAY_NAMESPACE=${RAY_NAMESPACE:-lattice-detection}
    networks:
      - latlab-net
      - lattice-net
    restart: unless-stopped
    # No depends_on - Ray cluster is external
    # GPU access â€” requires NVIDIA Container Toolkit on the host.
    # Remove this block if running on a CPU-only machine.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

# ============================================================================
# Networks
# ============================================================================
networks:
  latlab-net:
    driver: bridge
    name: latlab-network
  lattice-net:
    external: true
    name: lattice-network
